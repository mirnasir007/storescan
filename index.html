<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Warehouse Scanner</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#166534">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2402/2402229.png">
    
    <!-- Dynamic Manifest for PWA -->
    <link rel="manifest" id="my-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overscroll-behavior-y: contain; }
        
        /* Excel-like Grid Styling */
        .sheet-container {
            border: 1px solid #e2e8f0;
            background: white;
            overflow: hidden;
            border-radius: 6px;
        }
        .sheet-header {
            display: grid;
            /* Adjusted column widths: Gave more space to NAME (2fr) and SAL_BARCODE (1.3fr) */
            grid-template-columns: 1fr 1fr 1fr 1fr 2fr 1fr 0.8fr 1fr 1.3fr 1fr; 
            background-color: #f1f5f9;
            border-bottom: 2px solid #cbd5e1;
            font-size: 0.70rem; /* Slightly smaller to fit text */
            font-weight: 700;
            color: #475569;
            text-align: center;
        }
        .sheet-cell {
            padding: 6px 2px;
            border-right: 1px solid #cbd5e1;
            white-space: normal; /* Key Change: Allow text to wrap */
            word-wrap: break-word;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2; /* Better spacing for wrapped text */
        }
        .sheet-cell:last-child { border-right: none; }

        /* Textarea that looks like a grid */
        .sheet-input {
            width: 100%;
            height: 300px;
            border: none;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 24px; /* Matches grid background size */
            resize: none;
            outline: none;
            white-space: pre;
            overflow-x: auto;
            
            /* CSS Trick for Grid Lines */
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 100% 24px; /* Row height */
            background-attachment: local;
            color: #334155;
            padding-left: 10px;
        }

        /* Preview Table Styling */
        .preview-table th { background-color: #e2e8f0; color: #334155; font-size: 0.75rem; }
        .preview-table td { border: 1px solid #e2e8f0; padding: 4px 8px; font-size: 0.8rem; }
        
        /* Status Colors */
        .status-missing { background-color: #fee2e2; color: #991b1b; }
        .status-done { background-color: #dcfce7; color: #166534; }
        .status-extra { background-color: #fef9c3; color: #854d0e; }
        .status-partial { background-color: #ffedd5; color: #9a3412; }

        .hidden-section { display: none !important; }

        /* Custom Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Install Button Animation */
        .install-pulse {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(22, 101, 52, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(22, 101, 52, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 101, 52, 0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-2">
            <div class="bg-green-600 text-white p-1.5 rounded font-bold text-xl">XL</div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">Scanner</h1>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- Install Button (Hidden by default) -->
            <button id="installAppBtn" onclick="installPWA()" class="hidden-section flex items-center gap-1 bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-green-700 transition install-pulse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                INSTALL
            </button>
            
            <button onclick="showResetModal()" class="text-sm text-red-600 hover:text-red-800 font-medium px-3 py-1 border border-red-200 rounded hover:bg-red-50 transition">
                Reset
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow overflow-hidden flex flex-col p-4 max-w-7xl mx-auto w-full">

        <!-- STEP 1: EXCEL INPUT & PREVIEW -->
        <div id="setupSection" class="flex flex-col h-full gap-4">
            
            <!-- Instructions -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-sm text-blue-800">
                <strong>Step 1:</strong> Excel theke data copy kore nicher box-e paste korun.
            </div>

            <!-- Spreadsheet Input View -->
            <div class="sheet-container shadow-md flex flex-col flex-grow relative">
                <!-- Header Row (Visual Only) -->
                <div class="sheet-header">
                    <div class="sheet-cell">RECEIVE FROM</div>
                    <div class="sheet-cell">DATE</div>
                    <div class="sheet-cell">CHALLAN</div>
                    <div class="sheet-cell bg-yellow-50">BARCODE</div>
                    <div class="sheet-cell bg-blue-50">NAME</div>
                    <div class="sheet-cell">SALE PRICE</div>
                    <div class="sheet-cell">RQTY</div>
                    <div class="sheet-cell">AMOUNT</div>
                    <div class="sheet-cell bg-green-50">SAL_BARCODE (QTY)</div>
                    <div class="sheet-cell">BARCODE</div>
                </div>

                <!-- Input Area -->
                <div class="relative flex-grow bg-white overflow-hidden">
                    <textarea id="pasteArea" class="sheet-input w-full h-full" 
                        placeholder="Excel data paste korun..."
                        oninput="handleInputPreview()"></textarea>
                </div>

                <!-- Footer Actions -->
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <div id="previewStats" class="text-xs md:text-sm font-medium text-gray-600">Waiting...</div>
                    <button onclick="startScanning()" id="startBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded shadow font-bold disabled:opacity-50 disabled:cursor-not-allowed transition text-sm md:text-base" disabled>
                        Verify & Scan
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 2: SCANNING INTERFACE (Hidden Initially) -->
        <div id="scanSection" class="hidden-section flex flex-col h-full">
            
            <!-- Scanner Box -->
            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 mb-4 flex flex-col md:flex-row gap-4 items-center sticky top-0 z-10">
                <div class="w-full md:w-3/5">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Scan Barcode</label>
                    <div class="relative mt-1">
                        <input type="text" id="scanInput" class="w-full text-2xl font-mono p-3 border-2 border-blue-400 rounded-lg shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100 transition" placeholder="..." autocomplete="off">
                        <div class="absolute right-3 top-3 text-gray-400" onclick="document.getElementById('scanInput').focus()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                        </div>
                    </div>
                    <div id="lastScanMsg" class="h-6 mt-1 text-sm font-semibold text-gray-600 truncate">Ready...</div>
                </div>

                <!-- Dashboard -->
                <div class="w-full md:w-2/5 flex gap-2">
                    <div class="flex-1 bg-blue-50 p-2 rounded text-center border border-blue-100">
                        <div class="text-[10px] md:text-xs text-blue-600 font-bold uppercase">Total</div>
                        <div class="text-xl md:text-2xl font-bold text-blue-800" id="statTotal">0</div>
                    </div>
                    <div class="flex-1 bg-green-50 p-2 rounded text-center border border-green-100">
                        <div class="text-[10px] md:text-xs text-green-600 font-bold uppercase">Scanned</div>
                        <div class="text-xl md:text-2xl font-bold text-green-700" id="statScanned">0</div>
                    </div>
                    <div class="flex-1 bg-red-50 p-2 rounded text-center border border-red-100">
                        <div class="text-[10px] md:text-xs text-red-600 font-bold uppercase">Pending</div>
                        <div class="text-xl md:text-2xl font-bold text-red-700" id="statPending">0</div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm flex-grow overflow-hidden flex flex-col">
                <div class="overflow-x-auto overflow-y-auto h-full">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 sticky top-0 z-0">
                            <tr>
                                <th class="p-3 text-xs font-bold text-gray-500 uppercase border-b">Product</th>
                                <th class="p-3 text-xs font-bold text-gray-500 uppercase border-b hidden md:table-cell">Codes</th>
                                <th class="p-3 text-center text-xs font-bold text-gray-500 uppercase border-b">Tgt</th>
                                <th class="p-3 text-center text-xs font-bold text-gray-500 uppercase border-b">Scan</th>
                                <th class="p-3 text-center text-xs font-bold text-gray-500 uppercase border-b">Stat</th>
                            </tr>
                        </thead>
                        <tbody id="scanTableBody" class="divide-y divide-gray-100">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <button onclick="backToSetup()" class="mt-2 text-xs text-gray-500 hover:text-gray-800 self-center underline pb-2">
                Go back to Data Entry
            </button>
        </div>

    </main>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="resetModal" class="hidden-section fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <div class="flex flex-col items-center text-center">
                <div class="bg-red-100 p-3 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Clear All Data?</h3>
                <p class="text-gray-500 text-sm mb-6">Are you sure you want to reset? All scanned progress and pasted data will be lost permanently.</p>
                
                <div class="flex gap-3 w-full">
                    <button onclick="closeResetModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2.5 rounded font-semibold transition">
                        Cancel
                    </button>
                    <button onclick="confirmReset()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded font-semibold shadow-lg transition">
                        Yes, Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PWA SETUP START ---
        // Dynamically create the manifest for PWA installation
        const manifestData = {
            "name": "Warehouse Scanner",
            "short_name": "Scanner",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#166534",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2402/2402229.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2402/2402229.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#my-manifest').setAttribute('href', manifestURL);

        // Install Button Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            btn.classList.remove('hidden-section');
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installAppBtn').classList.add('hidden-section');
                }
                deferredPrompt = null;
            }
        }
        // --- PWA SETUP END ---

        // Audio Setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(isSuccess) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = isSuccess ? 'sine' : 'sawtooth';
            osc.frequency.value = isSuccess ? 1000 : 200;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + (isSuccess ? 0.1 : 0.3));
        }

        // State
        let parsedProducts = []; // The clean list used for scanning
        let barcodeIndexMap = {}; // Fast lookup

        // Column Indices
        const COL_BARCODE_MAIN = 3;
        const COL_NAME = 4;
        const COL_CODE_ALT1 = 5;
        const COL_CODE_ALT2 = 6;
        const COL_QTY = 8;

        // --- Logic: Parse & Preview ---
        function handleInputPreview() {
            const raw = document.getElementById('pasteArea').value;
            const rows = raw.split('\n');
            let validCount = 0;
            
            // Simple validation to enable button
            if (rows.length > 1) {
                const hasData = rows.some(r => {
                    const c = r.split('\t');
                    return c.length > 4 && c[COL_NAME] && c[COL_NAME].trim() !== "";
                });
                
                if (hasData) {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('startBtn').classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    validCount = rows.filter(r => r.split('\t').length > 4).length;
                    document.getElementById('previewStats').innerText = `Detected ${validCount} rows.`;
                    document.getElementById('previewStats').className = "text-sm font-bold text-green-600";
                    return;
                }
            }
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('previewStats').innerText = "Waiting for data...";
            document.getElementById('previewStats').className = "text-sm font-medium text-gray-600";
        }

        function startScanning() {
            const raw = document.getElementById('pasteArea').value;
            if(!raw) return;

            const rows = raw.split('\n');
            const tempMap = {};
            let skipped = 0;

            rows.forEach((row, idx) => {
                if(!row.trim()) return;
                const cols = row.split('\t');

                if(cols.length <= COL_NAME) { skipped++; return; }

                const name = cols[COL_NAME]?.trim();
                let mainCode = cols[COL_BARCODE_MAIN]?.trim();
                const alt1 = cols[COL_CODE_ALT1]?.trim();
                const alt2 = cols[COL_CODE_ALT2]?.trim();
                
                let qtyStr = cols[COL_QTY]?.trim() || "1";
                let qty = parseFloat(qtyStr.replace(/,/g, ''));
                if(isNaN(qty)) qty = 1;

                if(name === "NAME" || name.includes("Challan Total")) return;
                if(!name) { skipped++; return; }

                let codes = [];
                if(mainCode) codes.push(mainCode);
                if(alt1) codes.push(alt1);
                if(alt2) codes.push(alt2);

                const key = name.toUpperCase();

                if(tempMap[key]) {
                    tempMap[key].targetQty += qty;
                    codes.forEach(c => {
                        if(!tempMap[key].codes.includes(c)) tempMap[key].codes.push(c);
                    });
                } else {
                    tempMap[key] = {
                        name: name,
                        codes: codes,
                        targetQty: qty,
                        scannedQty: 0,
                        status: 'missing'
                    };
                }
            });

            parsedProducts = Object.values(tempMap);

            if(parsedProducts.length === 0) {
                alert("No valid products found! Please check columns.");
                return;
            }

            barcodeIndexMap = {};
            parsedProducts.forEach((p, idx) => {
                p.codes.forEach(c => {
                    barcodeIndexMap[c.toUpperCase()] = idx;
                });
            });

            renderScanTable();
            
            document.getElementById('setupSection').classList.add('hidden-section');
            document.getElementById('scanSection').classList.remove('hidden-section');
            setTimeout(() => document.getElementById('scanInput').focus(), 200);
        }

        // --- Logic: Scanning ---
        function renderScanTable() {
            const tbody = document.getElementById('scanTableBody');
            tbody.innerHTML = '';
            
            let tQty = 0, sQty = 0;

            parsedProducts.forEach((p, idx) => {
                tQty += p.targetQty;
                sQty += p.scannedQty;

                let badge = '';
                let rowClass = '';
                const diff = p.targetQty - p.scannedQty;

                if(p.scannedQty === 0) {
                    badge = '<span class="status-badge status-missing">Mis</span>';
                    rowClass = 'bg-white';
                } else if (p.scannedQty < p.targetQty) {
                    badge = `<span class="status-badge status-partial">Less(${diff})</span>`;
                    rowClass = 'bg-orange-50';
                } else if (p.scannedQty === p.targetQty) {
                    badge = '<span class="status-badge status-done">OK</span>';
                    rowClass = 'bg-green-50';
                } else {
                    badge = `<span class="status-badge status-extra">+${Math.abs(diff)}</span>`;
                    rowClass = 'bg-yellow-100';
                }

                const tr = document.createElement('tr');
                tr.className = `border-b group hover:bg-gray-50 transition ${rowClass}`;
                tr.id = `prod-${idx}`;
                tr.innerHTML = `
                    <td class="p-3">
                        <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                        <div class="md:hidden text-[10px] text-gray-400 font-mono mt-1 truncate max-w-[120px]">${p.codes.join(', ')}</div>
                    </td>
                    <td class="p-3 text-xs font-mono text-gray-500 break-all max-w-[150px] hidden md:table-cell">
                        ${p.codes.join(', ')}
                    </td>
                    <td class="p-3 text-center font-bold text-gray-600">${p.targetQty}</td>
                    <td class="p-3 text-center">
                        <span class="text-lg font-bold ${p.scannedQty >= p.targetQty ? 'text-green-700' : 'text-gray-400'}">
                            ${p.scannedQty}
                        </span>
                    </td>
                    <td class="p-3 text-center">${badge}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('statTotal').innerText = tQty;
            document.getElementById('statScanned').innerText = sQty;
            document.getElementById('statPending').innerText = tQty - sQty;
        }

        const scanInput = document.getElementById('scanInput');
        
        scanInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const val = scanInput.value.trim().toUpperCase();
                scanInput.value = '';
                if(val) processScan(val);
            }
        });

        document.body.addEventListener('click', (e) => {
            if(!document.getElementById('scanSection').classList.contains('hidden-section') && 
               !document.getElementById('resetModal').classList.contains('hidden-section') === false && 
               e.target.tagName !== 'BUTTON') {
                scanInput.focus();
            }
        });

        function processScan(code) {
            const idx = barcodeIndexMap[code];
            const msgEl = document.getElementById('lastScanMsg');

            if(idx !== undefined) {
                const prod = parsedProducts[idx];
                prod.scannedQty++;
                beep(true);
                msgEl.innerHTML = `<span class="text-green-600">✔ Found: ${prod.name}</span>`;
                
                renderScanTable();
                
                const row = document.getElementById(`prod-${idx}`);
                row.scrollIntoView({behavior: 'smooth', block: 'center'});
                row.classList.add('brightness-95'); 
                setTimeout(() => row.classList.remove('brightness-95'), 500);
            } else {
                beep(false);
                msgEl.innerHTML = `<span class="text-red-600">✖ Unknown Code: ${code}</span>`;
            }
        }

        function backToSetup() {
            document.getElementById('setupSection').classList.remove('hidden-section');
            document.getElementById('scanSection').classList.add('hidden-section');
        }

        function showResetModal() {
            document.getElementById('resetModal').classList.remove('hidden-section');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden-section');
        }

        function confirmReset() {
            location.reload();
        }
    </script>
</body>
</html>
